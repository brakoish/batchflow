generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  WORKER
  OWNER
}

enum BatchStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum StepStatus {
  LOCKED
  IN_PROGRESS
  COMPLETED
}

enum StepType {
  CHECK
  COUNT
}

model Worker {
  id          String        @id @default(cuid())
  name        String
  pin         String        @unique
  role        Role
  createdAt   DateTime      @default(now())
  progressLogs ProgressLog[]
  assignments BatchAssignment[]
  shifts      Shift[]
}

model Recipe {
  id          String        @id @default(cuid())
  name        String
  description String?
  baseUnit    String        @default("units")
  createdAt   DateTime      @default(now())
  steps       RecipeStep[]
  batches     Batch[]
  units       RecipeUnit[]
}

model RecipeUnit {
  id          String        @id @default(cuid())
  recipeId    String
  recipe      Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  name        String
  ratio       Int           @default(1)
  order       Int           @default(0)
  steps       RecipeStep[]

  @@index([recipeId])
}

model RecipeStep {
  id          String        @id @default(cuid())
  recipeId    String
  recipe      Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  name        String
  order       Int
  notes       String?
  type        StepType      @default(COUNT)
  unitId      String?
  unit        RecipeUnit?   @relation(fields: [unitId], references: [id])
  batchSteps  BatchStep[]

  @@index([recipeId])
  @@index([unitId])
}

model Batch {
  id              String        @id @default(cuid())
  recipeId        String
  recipe          Recipe        @relation(fields: [recipeId], references: [id])
  name            String
  targetQuantity  Int
  baseUnit        String        @default("units")
  status          BatchStatus   @default(ACTIVE)
  startDate       DateTime      @default(now())
  completedDate   DateTime?
  createdAt       DateTime      @default(now())
  steps           BatchStep[]
  assignments     BatchAssignment[]

  @@index([recipeId])
  @@index([status])
}

model BatchAssignment {
  id        String   @id @default(cuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  workerId  String
  worker    Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([batchId, workerId])
  @@index([batchId])
  @@index([workerId])
}

enum ShiftStatus {
  ACTIVE
  COMPLETED
}

model Shift {
  id          String      @id @default(cuid())
  workerId    String
  worker      Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  status      ShiftStatus @default(ACTIVE)
  startedAt   DateTime    @default(now())
  endedAt     DateTime?
  notes       String?
  createdAt   DateTime    @default(now())

  @@index([workerId])
  @@index([status])
  @@index([startedAt])
}

model BatchStep {
  id                String        @id @default(cuid())
  batchId           String
  batch             Batch         @relation(fields: [batchId], references: [id], onDelete: Cascade)
  recipeStepId      String
  recipeStep        RecipeStep    @relation(fields: [recipeStepId], references: [id])
  name              String
  order             Int
  type              StepType      @default(COUNT)
  unitLabel         String        @default("units")
  unitRatio         Int           @default(1)
  targetQuantity    Int
  completedQuantity Int           @default(0)
  status            StepStatus    @default(LOCKED)
  progressLogs      ProgressLog[]

  @@index([batchId])
  @@index([recipeStepId])
}

model ProgressLog {
  id          String      @id @default(cuid())
  batchStepId String
  batchStep   BatchStep   @relation(fields: [batchStepId], references: [id], onDelete: Cascade)
  workerId    String
  worker      Worker      @relation(fields: [workerId], references: [id])
  quantity    Int
  note        String?
  createdAt   DateTime    @default(now())

  @@index([batchStepId])
  @@index([workerId])
  @@index([createdAt])
}
